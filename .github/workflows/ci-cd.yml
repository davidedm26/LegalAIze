name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest
    
    - name: Lint with flake8
      run: |
        # Stop su errori di sintassi o nomi non definiti
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero tratta tutti gli errori come warning
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: Test Backend
      run: |
        echo "âœ“ Backend tests passed (placeholder)"
    
    - name: Test Frontend
      run: |
        echo "âœ“ Frontend tests passed (placeholder)"

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Backend Image
      run: |
        docker build -t ml-backend:latest ./backend
    
    - name: Build Frontend Image
      run: |
        docker build -t ml-frontend:latest ./frontend
    
    - name: Test Docker Compose
      run: |
        echo "âœ“ Docker images built successfully"

  train-model:
    name: Train & Track Model
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Init DVC
      run: |
        if [ ! -d ".dvc" ]; then
          dvc init --no-scm
        fi

    - name: Setup DVC
      run: |
        dvc remote list | grep -q '^origin' || dvc remote add -d origin https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/${{ github.event.repository.name }}.dvc
        dvc remote default origin
        dvc remote modify origin --local auth basic
        dvc remote modify origin --local user ${{ secrets.DAGSHUB_USERNAME }}
        dvc remote modify origin --local password ${{ secrets.DAGSHUB_TOKEN }}
      continue-on-error: true

    - name: Verify DagHub Connection
      env:
        MLFLOW_TRACKING_URI: "https://dagshub.com/${{ github.repository }}.mlflow"
        DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        python -c "import mlflow; print(f'MLflow tracking URI: {mlflow.get_tracking_uri()}')"
    
    - name: Train Model
      env:
        MLFLOW_TRACKING_URI: "https://dagshub.com/${{ github.repository }}.mlflow"
        DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        python train_model.py

    - name: Commit DVC outputs
      run: |
        dvc commit models/model.pkl
      continue-on-error: true

    - name: Push to DVC
      run: |
        dvc push
      continue-on-error: true
    
    - name: Commit DVC files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        #git add models/model.pkl.dvc
        git add .dvc/config
        git commit -m "Update model artifacts [skip ci]" || echo "No changes to commit"
        git push || echo "Nothing to push"
      continue-on-error: true

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build-docker, train-model]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy (Placeholder)
      run: |
        echo "ðŸš€ Deploy step - Configure according to your deployment target"
        echo "Options: Docker Hub, AWS ECR, Azure Container Registry, etc."
